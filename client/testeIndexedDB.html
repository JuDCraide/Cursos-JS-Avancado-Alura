<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Aprendendo IndexedDB</title>
  </head>
  <body>
    <script src="js/app/models/Negociacao.js"></script>
    <script>
	
      var connection;
      var openRequest = window.indexedDB.open("aluraframe", 3);

      openRequest.onupgradeneeded = (e) => {
        console.log("Cria ou altera um banco já existente");

        let minhaConnection = e.target.result;

        if (minhaConnection.objectStoreNames.contains('negociacoes')) {
          minhaConnection.deleteObjectStore("negociacoes");
        }

		    minhaConnection.createObjectStore("negociacoes",{autoIncrement: true});
      };
      openRequest.onsuccess = (e) => {
        console.log("Conexão obtida com sucesso");
        
        connection = e.target.result;
      };
      openRequest.onerror = (e) => console.log(e.target.error);

      function adiciona() {

        let transaction = connection.transaction(["negociacoes"], "readwrite");
        let store = transaction.objectStore("negociacoes");

        let negociacao = new Negociacao(new Date(), 200, 1);
        let request = store.add(negociacao);

        request.onsuccess = (e) => console.log("Incluida com sucesso");

        request.onerror = (e) => console.log("Erro ao incluir negociação");
      }

	  function listaTodos() {
		let transaction = connection.transaction(["negociacoes"], "readwrite");
        let store = transaction.objectStore("negociacoes");

		let cursor = store.openCursor();
		let negociacoes = [];

		cursor.onsuccess = e => {
			let atual = e.target.result;
			
			if(atual){
				let dado = atual.value;
				negociacoes.push(new Negociacao(dado._data, dado._quantidade, dado._valor));
				
				atual.continue();
			} else {
				console.log(negociacoes);			
			}
		}
		cursor.onerror = e => console.log(e.target.error.name);
		
	  }

    //queremos cria uma classe ConnectionFactory que respeite
    //a) getConnection vai ser estático -> chamado direto da classe
    //b) getConnection retorna uma promisse, pq é assíncrono
    //c) não importa quantas vezes seja chamar getConnection a conexão deve ser a mesma
    //d) não pode chamar close diretamente, só pode ser fechada através da ConnectionFactory
    ConnectionFactory
      .getConnection()
      .then(connection => {
        //usa conexão
    });

    ConnectionFactory
      .getConnection()
      .then(connection => {
        //conexão tem que ser a mesma 
    });

    </script>
  </body>
</html>
