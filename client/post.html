<html>
  <head>
    <meta charset="UTF-8" />
    <title>Negociações</title>
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/bootstrap-theme.css" />
  </head>

  <body class="container">
    <form class="form">
      <div class="form-group">
        <label for="data">Data</label>
        <input type="date" id="data" class="form-control" required autofocus />
      </div>

      <div class="form-group">
        <label for="quantidade">Quantidade</label>
        <input
          type="number"
          min="1"
          step="1"
          id="quantidade"
          class="form-control"
          value="1"
          required
        />
      </div>

      <div class="form-group">
        <label for="valor">Valor</label>
        <input
          id="valor"
          type="number"
          class="form-control"
          min="0.01"
          step="0.01"
          value="0.0"
          required
        />
      </div>

      <button class="btn btn-primary" type="submit" onclick="sendPost(event)">
        Enviar dados para servidor
      </button>
    </form>

    <script src="js/app/models/Negociacao.js"></script>
    <script src="js/app/helpers/DateHelper.js"></script>
    <script>
      function sendPost(event) {
        event.preventDefault();
        console.log("Enviando post");

        //aqui você deve ler os dados do formulário
        //construir o json
        //enviar o XMLHttpRequest

        let $ = document.querySelector.bind(document);

        this._inputData = $("#data");
        this._inputQuantidade = $("#quantidade");
        this._inputValor = $("#valor");

        //meu código que não funcionou
        //aparentemente o problema é que a api faz a mesma conversão que o DataHelper
        //portanto eu não deveria mandar um objeto de Negociacao
        //mas achei mais confuso
        /*
        let negociacao = new Negociacao(
          DataHelper.textoParaData(this._inputData.value),
          this._inputQuantidade.value,
          this._inputValor.value
        );*/

        //resposta
        const negociacao2 = {
          data: _inputData.value,
          quantidade: _inputQuantidade.value,
          valor: _inputValor.value,
        };

        //console.log(negociacao,negociacao2, JSON.stringify(negociacao));

        let xhr = new XMLHttpRequest();


        //na resposta manda um terceiro parametro como true
        //pelo q pesquisei ele manda se a operçã é assincrona
        //não entendi mto bem pq o meu funcionou sem o true
        //meu código
        /*xhr.open("POST", "/negociacoes");*/
        //resposta
        xhr.open("POST", "/negociacoes", true);

        xhr.setRequestHeader("Content-type", "application/json");

        xhr.onreadystatechange = () => {
          if (xhr.readyState == 4) {
            if (xhr.status == 200) {
              console.log("OK");

              //tinha esquecido de limpar o formulário
              this._inputData.value = "";
              this._inputQuantidade.value = 1;
              this._inputValor.value = 0.0;

              this._inputData.focus();
            } else {
              console.log("Erro");
              console.log(xhr.responseText);
            }
          }
        };

        //xhr.send(JSON.stringify(negociacao));
        xhr.send(JSON.stringify(negociacao2));
      }
    </script>
  </body>
</html>
